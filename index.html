<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RatoNet - Streaming IRL</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Michroma&display=swap" rel="stylesheet">
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ratonet: {
                            primary: '#ff6600',
                            dark: '#0a0a0a',
                            panel: '#111111',
                            border: '#222222',
                            textMuted: '#888888'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Michroma', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; color: #fff; height: 100%; width: 100%; }
        #map { position: absolute; inset: 0; z-index: 0; background: #0a0a0a; height: 100vh; width: 100vw; }
        
        /* Overrides para os painéis ficarem acima do mapa */
        .ui-layer { position: absolute; z-index: 1000; pointer-events: none; }
        .ui-interactive { pointer-events: auto; }

        /* Estilização Customizada da Barra de Rolagem */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Esconder os controles padrão do Leaflet */
        .leaflet-control-zoom { display: none !important; }
        .leaflet-control-attribution { display: none !important; }

        /* Marcadores Customizados do Mapa */
        .streamer-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60px;
            margin-left: -30px; /* Centralizar no ponto */
            margin-top: -30px;
            filter: drop-shadow(0px 4px 10px rgba(0,0,0,0.5));
        }
        
        /* Correção do overflow do avatar */
        .streamer-avatar-wrapper {
            position: relative;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--marker-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .streamer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #111;
            background-color: #222;
            box-sizing: border-box; /* Impede que a borda vaze do círculo */
        }

        .streamer-status-dot {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background-color: #ef4444; /* red-500 */
            border: 2px solid #111;
            border-radius: 50%;
            z-index: 10;
        }

        .streamer-name-tag {
            margin-top: 4px;
            background-color: rgba(0, 0, 0, 0.75);
            color: #fff;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            backdrop-filter: blur(4px);
            white-space: nowrap;
        }

        /* Ícones Sociais Menores */
        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            color: #aaa;
            font-size: 10px;
            transition: all 0.2s;
        }
        .social-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
    </style>
</head>
<body class="font-sans antialiased text-white selection:bg-ratonet-primary selection:text-white">

    <!-- Container do Mapa -->
    <div id="map"></div>

    <!-- Banner de Status da Conexão -->
    <div id="status-banner" class="ui-layer top-6 left-1/2 -translate-x-1/2 w-max max-w-[90vw]">
        <div class="bg-blue-500/10 backdrop-blur-md border border-blue-500/30 text-blue-400 px-4 py-2 rounded-full text-xs font-medium flex items-center gap-2 shadow-lg">
            <i class="fa-solid fa-satellite-dish text-sm"></i>
            <span class="text-center">Conectando ao servidor...</span>
        </div>
    </div>

    <!-- Interface (Esquerda) -->
    <div class="ui-layer top-0 left-0 p-6 flex flex-col gap-4 w-full md:w-auto">
        
        <!-- Navegação / Pílulas -->
        <div class="ui-interactive flex items-center bg-black/60 backdrop-blur-md border border-white/10 rounded-full p-1.5 shadow-lg w-max max-w-full overflow-x-auto">
            <button class="flex items-center gap-2 bg-white/10 text-ratonet-primary px-4 py-2 rounded-full font-medium text-sm transition-colors whitespace-nowrap">
                <i class="fa-solid fa-map"></i> Mapa
            </button>
            <button onclick="showDemoToast('eyeRat')" class="flex items-center gap-2 text-white/70 hover:text-white px-4 py-2 rounded-full font-medium text-sm transition-colors whitespace-nowrap">
                <i class="fa-solid fa-tv"></i> eyeRat
            </button>
            <button onclick="showDemoToast('Split')" class="flex items-center gap-2 text-white/70 hover:text-white px-4 py-2 rounded-full font-medium text-sm transition-colors whitespace-nowrap">
                <i class="fa-solid fa-bolt"></i> Split
            </button>
        </div>

        <!-- Card de Status -->
        <div class="ui-interactive bg-[#0a0a0a]/80 backdrop-blur-md border border-white/10 rounded-2xl p-4 shadow-xl w-72 mt-2 hidden sm:block">
            <h1 class="font-display text-ratonet-primary text-sm uppercase tracking-wider mb-1">RatoNet</h1>
            <p class="text-xs text-ratonet-textMuted" id="status-card-info">Streaming IRL Open Source</p>
        </div>
    </div>

    <!-- Interface (Direita - Sidebar) -->
    <div class="ui-layer top-0 right-0 h-full w-[340px] flex flex-col ui-interactive hidden md:flex">
        <div class="flex-1 bg-ratonet-panel/95 backdrop-blur-xl border-l border-ratonet-border flex flex-col shadow-2xl pt-4">
            
            <!-- Cabeçalho Sidebar -->
            <div class="p-6 pb-4 border-b border-white/5">
                <h2 class="font-display text-ratonet-primary text-lg uppercase tracking-wide">RatoNet</h2>
                <p class="text-xs text-ratonet-textMuted mt-1" id="sidebar-subtitle">Aguardando streamers...</p>
            </div>

            <!-- Lista de Streamers -->
            <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-1" id="streamer-list">
                <!-- Injetado via JS -->
            </div>

            <!-- Rodapé da Sidebar -->
            <div class="p-4 flex flex-col items-end gap-4 mt-auto">
                <!-- Footer Ratonet -->
                <div class="w-full pt-4 border-t border-white/5 text-center">
                    <a href="https://ratonet.com.br" target="_blank" rel="noopener noreferrer" class="text-white/30 text-[10px] uppercase tracking-widest hover:text-ratonet-primary transition-colors">
                        Powered by <span class="font-display">RATONET</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles de Zoom Customizados (Bottom Right do Mapa) -->
    <div class="ui-layer bottom-6 right-6 md:right-[360px] flex flex-col gap-2 ui-interactive">
        <button id="zoom-in" class="w-10 h-10 bg-ratonet-panel/90 hover:bg-[#222] border border-white/10 rounded-lg flex items-center justify-center text-white transition-colors shadow-lg">
            <i class="fa-solid fa-plus"></i>
        </button>
        <button id="zoom-out" class="w-10 h-10 bg-ratonet-panel/90 hover:bg-[#222] border border-white/10 rounded-lg flex items-center justify-center text-white transition-colors shadow-lg">
            <i class="fa-solid fa-minus"></i>
        </button>
    </div>

    <!-- Container de Toasts/Notificações -->
    <div id="toast-container" class="ui-layer bottom-10 left-1/2 -translate-x-1/2 flex flex-col gap-2 items-center z-[2000]"></div>

    <!-- Scripts Leaflet e Lógica -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // ============================================================
        // RatoNet Dashboard - Frontend com WebSocket em tempo real
        // ============================================================

        // Sistema simples de Notificações (Toast) para o Modo Demo
        function showDemoToast(featureName) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            toast.className = 'bg-[#111] border border-ratonet-primary text-white px-4 py-3 rounded-xl text-sm font-medium shadow-2xl backdrop-blur-md transform transition-all duration-300 translate-y-4 opacity-0 flex items-center gap-3';
            toast.innerHTML = `
                <div class="bg-ratonet-primary/20 p-2 rounded-lg text-ratonet-primary"><i class="fa-solid fa-person-digging"></i></div>
                <div>A aba <span class="text-ratonet-primary font-bold">${featureName}</span> está em modo demo.<br><span class="text-xs text-white/60 font-normal">Integração funcional em breve!</span></div>
            `;

            container.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
            });

            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-4', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        // Estado global dos streamers (alimentado via WebSocket ou fallback)
        let streamers = [];
        const markers = {};      // id → L.marker
        const polylines = {};    // id → L.polyline

        // Mapa de ícones sociais (backend envia nomes simples, frontend converte para Font Awesome)
        const socialIconMap = {
            'instagram': 'fa-instagram',
            'tiktok': 'fa-tiktok',
            'twitter': 'fa-twitter',
            'youtube': 'fa-youtube',
        };

        // Inicializar Mapa
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([-13.0, -52.0], 5);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
        }).addTo(map);

        // Controles de zoom customizados
        document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
        document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());

        // Trail de posições reais por streamer (acumula GPS ao vivo)
        const trails = {};  // streamer_id → [latLng, ...]
        const MAX_TRAIL_POINTS = 500;

        const sidebarList = document.getElementById('streamer-list');
        const defaultAvatar = "https://ui-avatars.com/api/?background=random&color=fff&name=";

        // ============================================================
        // Renderização de streamers (reutilizado por WebSocket e fallback)
        // ============================================================

        function renderStreamers(streamerList) {
            // Se lista vazia, mostra estado vazio
            if (!streamerList || streamerList.length === 0) {
                renderEmptyState();
                return;
            }

            // Limpa sidebar
            sidebarList.innerHTML = '';

            // Atualiza contadores
            const liveCount = streamerList.filter(s => s.is_live).length;
            const sidebarSub = document.getElementById('sidebar-subtitle');
            if (sidebarSub) {
                sidebarSub.textContent = `${streamerList.length} streamer${streamerList.length !== 1 ? 's' : ''} \u2022 ${liveCount} ao vivo`;
            }
            const statusCard = document.getElementById('status-card-info');
            if (statusCard) {
                statusCard.textContent = `${liveCount} ao vivo`;
            }

            streamerList.forEach((streamer, index) => {
                const latLng = [streamer.gps.lat, streamer.gps.lng];
                const speed = streamer.gps.speed_kmh;
                const speedText = speed > 0 ? `${Math.round(speed)} km/h` : '0 km/h';
                const socials = (streamer.socials || []).map(s => socialIconMap[s] || `fa-${s}`);
                const healthScore = streamer.health ? streamer.health.score : null;
                const healthState = streamer.health ? streamer.health.state : 'healthy';

                // Cor do indicador de saúde
                let healthColor = '#10b981'; // green
                if (healthState === 'degraded') healthColor = '#f59e0b';
                else if (healthState === 'critical') healthColor = '#ef4444';
                else if (healthState === 'down') healthColor = '#6b7280';

                // --- Marcador no mapa ---
                if (latLng[0] !== 0 || latLng[1] !== 0) {
                    // Acumula trail real
                    if (!trails[streamer.id]) trails[streamer.id] = [];
                    const trail = trails[streamer.id];
                    const lastPt = trail.length > 0 ? trail[trail.length - 1] : null;
                    if (!lastPt || lastPt[0] !== latLng[0] || lastPt[1] !== latLng[1]) {
                        trail.push(latLng);
                        if (trail.length > MAX_TRAIL_POINTS) trail.shift();
                    }

                    // Atualiza ou cria polyline
                    if (polylines[streamer.id]) {
                        polylines[streamer.id].setLatLngs(trail);
                    } else {
                        polylines[streamer.id] = L.polyline(trail, {
                            color: streamer.color,
                            weight: 4,
                            opacity: 0.8,
                            lineJoin: 'round'
                        }).addTo(map);
                    }
                }

                if (markers[streamer.id]) {
                    markers[streamer.id].setLatLng(latLng);
                } else {
                    const customIcon = L.divIcon({
                        className: '',
                        html: `
                            <div class="streamer-marker" style="--marker-color: ${streamer.color}">
                                <div class="streamer-avatar-wrapper">
                                    <img src="${streamer.avatar_url}" onerror="this.onerror=null;this.src='${defaultAvatar + streamer.name}'" class="streamer-avatar" alt="${streamer.name}">
                                    <div class="streamer-status-dot" style="background-color: ${streamer.is_live ? '#ef4444' : '#6b7280'}"></div>
                                </div>
                                <div class="streamer-name-tag">${streamer.name.split(' ')[0]}</div>
                            </div>
                        `,
                        iconSize: [60, 60],
                        iconAnchor: [30, 30]
                    });
                    markers[streamer.id] = L.marker(latLng, { icon: customIcon }).addTo(map);
                }

                // --- Item na Sidebar ---
                const socialHtml = socials.map(icon =>
                    `<button class="social-btn" onclick="event.stopPropagation(); showDemoToast('Redes Sociais')"><i class="fa-brands ${icon}"></i></button>`
                ).join('');

                // Health badge
                const healthBadge = healthScore !== null
                    ? `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded" style="background: ${healthColor}20; color: ${healthColor}">${healthScore}%</span>`
                    : '';

                const listItemHtml = `
                    <div class="flex p-2.5 rounded-xl hover:bg-white/5 cursor-pointer transition-colors group" onclick="showDemoToast('Câmera de ${streamer.name.split(' ')[0]}')">
                        <div class="relative flex-shrink-0 mr-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center overflow-hidden" style="background-color: ${streamer.color}">
                                <img src="${streamer.avatar_url}" onerror="this.onerror=null;this.src='${defaultAvatar + streamer.name}'" class="w-[36px] h-[36px] rounded-full object-cover border-2 border-black" alt="${streamer.name}">
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1.5 mb-1">
                                <h3 class="text-sm font-semibold text-white/90 truncate group-hover:text-white transition-colors">${streamer.name}</h3>
                                ${streamer.is_crown ? '<i class="fa-solid fa-crown text-yellow-500 text-[10px]" title="Host"></i>' : ''}
                            </div>
                            <div class="flex items-center flex-wrap gap-2">
                                <span class="bg-red-600 text-white text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider">${streamer.is_live ? 'Live' : 'Offline'}</span>
                                <span class="text-xs text-ratonet-textMuted">${speedText}</span>
                                ${healthBadge}
                            </div>
                            ${socialHtml ? `<div class="flex gap-1.5 mt-2">${socialHtml}</div>` : ''}
                        </div>
                    </div>
                `;
                sidebarList.insertAdjacentHTML('beforeend', listItemHtml);
            });
        }

        // ============================================================
        // WebSocket - Conexão com o backend RatoNet
        // ============================================================

        let ws = null;
        let wsReconnectTimer = null;

        function connectWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${location.host}/ws/dashboard`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('[RatoNet] WebSocket conectado');
                updateBanner('connected');
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);

                    if (msg.type === 'full_sync' && msg.data.streamers) {
                        streamers = msg.data.streamers;
                        renderStreamers(streamers);
                    } else if (msg.type === 'streamer_update' && msg.data.streamer) {
                        const idx = streamers.findIndex(s => s.id === msg.data.streamer_id);
                        if (idx !== -1) {
                            streamers[idx] = msg.data.streamer;
                        } else {
                            streamers.push(msg.data.streamer);
                        }
                        renderStreamers(streamers);
                    } else if (msg.type === 'streamer_online' && msg.data.streamer) {
                        const existing = streamers.findIndex(s => s.id === msg.data.streamer.id);
                        if (existing !== -1) {
                            streamers[existing] = msg.data.streamer;
                        } else {
                            streamers.push(msg.data.streamer);
                        }
                        renderStreamers(streamers);
                    } else if (msg.type === 'streamer_offline' && msg.data.streamer_id) {
                        const idx = streamers.findIndex(s => s.id === msg.data.streamer_id);
                        if (idx !== -1) {
                            // Remove marcador e rota do mapa
                            if (markers[msg.data.streamer_id]) {
                                map.removeLayer(markers[msg.data.streamer_id]);
                                delete markers[msg.data.streamer_id];
                            }
                            if (polylines[msg.data.streamer_id]) {
                                map.removeLayer(polylines[msg.data.streamer_id]);
                                delete polylines[msg.data.streamer_id];
                            }
                            delete trails[msg.data.streamer_id];
                            streamers.splice(idx, 1);
                        }
                        renderStreamers(streamers);
                    }
                } catch (e) {
                    console.warn('[RatoNet] Erro ao processar mensagem:', e);
                }
            };

            ws.onclose = () => {
                console.log('[RatoNet] WebSocket desconectado, reconectando em 3s...');
                updateBanner('disconnected');
                wsReconnectTimer = setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (err) => {
                console.warn('[RatoNet] WebSocket erro:', err);
                ws.close();
            };
        }

        // ============================================================
        // Banner de status + estado vazio
        // ============================================================

        function updateBanner(state) {
            const banner = document.querySelector('#status-banner > div');
            if (!banner) return;
            const span = banner.querySelector('span');
            const icon = banner.querySelector('i');

            // Remove classes anteriores
            banner.className = 'backdrop-blur-md px-4 py-2 rounded-full text-xs font-medium flex items-center gap-2 shadow-lg';

            if (state === 'connected') {
                banner.classList.add('bg-green-500/10', 'border', 'border-green-500/30', 'text-green-400');
                icon.className = 'fa-solid fa-signal text-sm';
                span.textContent = 'Conectado ao servidor — dados em tempo real';
                // Esconde banner após 3s
                setTimeout(() => { document.getElementById('status-banner').style.display = 'none'; }, 3000);
            } else if (state === 'disconnected') {
                banner.classList.add('bg-yellow-500/10', 'border', 'border-yellow-500/30', 'text-yellow-400');
                icon.className = 'fa-solid fa-satellite-dish text-sm';
                span.textContent = 'Reconectando ao servidor...';
                document.getElementById('status-banner').style.display = '';
            } else if (state === 'api_fallback') {
                banner.classList.add('bg-blue-500/10', 'border', 'border-blue-500/30', 'text-blue-400');
                icon.className = 'fa-solid fa-database text-sm';
                span.textContent = 'Dados via API — sem tempo real';
                setTimeout(() => { document.getElementById('status-banner').style.display = 'none'; }, 5000);
            } else if (state === 'empty') {
                banner.classList.add('bg-white/5', 'border', 'border-white/10', 'text-white/60');
                icon.className = 'fa-solid fa-satellite-dish text-sm';
                span.textContent = 'Nenhum streamer ao vivo no momento';
                document.getElementById('status-banner').style.display = '';
            }
        }

        function renderEmptyState() {
            sidebarList.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 text-center">
                    <div class="text-4xl mb-4 opacity-30"><i class="fa-solid fa-satellite-dish"></i></div>
                    <h3 class="text-sm font-semibold text-white/50 mb-2">Nenhum streamer ao vivo</h3>
                    <p class="text-xs text-white/30 px-4">Quando streamers conectarem seus field agents, eles aparecerão aqui automaticamente.</p>
                </div>
            `;
        }

        // Fallback via API REST (sem WebSocket)
        async function fetchStreamersFromAPI() {
            try {
                const resp = await fetch('/api/streamers');
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                if (data.length > 0) {
                    streamers = data;
                    renderStreamers(streamers);
                    updateBanner('api_fallback');
                } else {
                    renderEmptyState();
                    updateBanner('empty');
                }
            } catch(e) {
                console.log('[RatoNet] API também indisponível:', e.message);
                renderEmptyState();
                updateBanner('empty');
            }
        }

        // ============================================================
        // Inicialização
        // ============================================================

        // Tenta conectar via WebSocket
        try {
            connectWebSocket();
        } catch(e) {
            console.log('[RatoNet] WebSocket indisponível, tentando API...');
            fetchStreamersFromAPI();
        }

        // Se após 3s não recebeu dados do WS, tenta via API REST
        setTimeout(() => {
            if (streamers.length === 0) {
                console.log('[RatoNet] Timeout WebSocket, buscando via API...');
                fetchStreamersFromAPI();
            }
        }, 3000);

        // Centraliza no mundo — faz zoom nos streamers quando eles aparecerem
        map.setView([0, 0], 3);
    </script>
</body>
</html>